# System Performance: Enterprise and Cloud

## 序言

本章学习目标：

* 理解系统性能，角色，活动和挑战。

* 理解观测工具和实验工具的区别。

* 对性能观测量有基本理解：数据，剖析，火焰图，跟踪，静态指令和动态指令。

* 学习任务方法论和Linux60秒排查。

### 性能

系统性能研究包含软硬件部分，它们都对性能有影响，目标是提升终端用户体验和减少计算消耗。

一个通用的系统软件栈：

![通用系统软件栈](static/sp_1_1.png)


### 角色

系统性能由不同的任务角色所决定。每个角色只关注自己的领域。但是在某些系统问题上需要不同角色之间的协作。

某些公司会雇佣专门的性能分析团队与不同角色合作解决性能问题，并且开发相关的工具。


### 活动

系统性能与很多活动有关。

以下的步骤帮助在软件从开发到部署中提高性能发挥作用：

* 制定性能目标和性能模型

* 了解软件原型和硬件的性能特征

* 在测试环境对开发中的软件进行性能分析

* 对新版本软件进行非回归测试

* 压测生产版本

* 在生产环境验证测试

* 对生产进行调整

* 在调整中监控软件变化

* 对生产问题进行性能分析

* 回顾生产问题

* 开发软件去增强系统性能


开发团队在开发初期往往不重视生产性能，往往导致后期出现生产性能问题后更加难以修复。

金丝雀测试和蓝绿测试在允许失败的情况下发布让产品在生产发布，以达到性能分析的目的。

不同的公司可以在以上步骤中按照需求选择。

### 不同视角

负载分析和资源分析是系统分析的两个不同视角。

系统管理员对系统资源负责，开发者则主要关注负载。性能分析需要两方面一起配合。

### 挑战

#### 主观

生产问题是客观的，可以判断是否存在，而性能问题是客观的，对于不同的人会有不同的结论。客观的性能问题可以通过确定一个清晰的目标变得主管，比如明确响应延迟时间范围。

#### 复杂度

我们往往不知道从哪个环节开始分析问题，有时候我们会预设问题所在，从那里开始入手，分析人员必须明确那里是不是问题所在。

性能问题也来源于复杂的交互活动，一个系统可能在单独分析时表现很好，与其他组件交互时出现问题，我们必须知道它们之间怎么互相影响的。

性能瓶颈也是复杂和难以预料的，修复了一处往往会出现另一处，系统性能整体上没有提升。

性能也受复杂的生产负载影响，在实验环境难以复现并且偶发。

性能问题需要对系统从内而外整体分析，因此要求性能工程师需要有广泛的技能，是一项很有挑战的工作。

#### 多因素影响

一个性能问题可能没有一个明确的原因，而是多个不同的原因同时发生导致的，同时也可能导致多个性能问题。

#### 多个性能问题

当线上出现多个性能问题是，我们需要优先明确对提升负载最有效的，优先修复。


### 延迟

延迟是系统的性能的重要指标。消除延迟可以最大程度上提升性能。

延迟在不同领域有所区别，在网络，它指建立建立连接所需的时间也可以指包括数据传输在内的整个过程耗时，因此，需要区分为连接延迟和传输延迟。

### 可观测性

可观测性指我们可以通过工具来观察和理解系统。包括计数器，剖析工具，追踪工具。

在生产环境需要先运行观测工具，因为压测工具会占用资源影响性能。

#### 计数器

应用和系统在它们内部存储了有关它们自身状态和活动的数据：运行次数，字节数，延迟，资源利用率和错误率。这些数据由性能工具定时读取并计算出平均值，百分比等。

#### 指标

指标是被挑选出来作为目标监控和评估的。